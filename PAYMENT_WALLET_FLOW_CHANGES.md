# ุชุบููุฑุงุช ุชุฏูู ุงูุฏูุน: ุดุญู ุงููุญูุธุฉ ูุจู ุงูุดุฑุงุก

## ๐ ููุฎุต ุงูุชุบููุฑุงุช

ุชู ุชุนุฏูู ุชุฏูู ุดุฑุงุก ุงููุฑุตุฉ ุนู ุทุฑูู ุจูุงุจุฉ ุงูุฏูุน ุจุญูุซ ูุชู:
1. **ุดุญู ุงูุฑุตูุฏ ูู ุงููุญูุธุฉ ุฃููุงู** ุนูุฏ ูุฌุงุญ ุงูุฏูุน
2. **ุณุญุจ ุงูุฑุตูุฏ ูู ุงููุญูุธุฉ** ูุดุฑุงุก ุงููุฑุตุฉ

## โ ุงูููุงุฆุฏ

1. **ุชุณุฌูู ุฌููุน ุนูููุงุช ุงููุญูุธุฉ**: ูู ุนูููุฉ ุดุญู ูุณุญุจ ุชูุณุฌู ูู ุณุฌู ุงููุญูุธุฉ
2. **ุงูุฃูุงู ูู ุญุงูุฉ ุงููุดู**: ุฅุฐุง ูุดู ุดุฑุงุก ุงููุฑุตุฉุ ุงูุฑุตูุฏ ูุจูู ูู ุงููุญูุธุฉ ููููู ุงุณุชุฑุฌุงุนู
3. **ุดูุงููุฉ ุงูุนูููุงุช**: ูููู ูููุณุชุฎุฏู ุฑุคูุฉ ุฌููุน ุนูููุงุช ุงููุญูุธุฉ ุจูุถูุญ

---

## ๐ ุงูุชุฏูู ุงูุฌุฏูุฏ

### ูุจู ุงูุชุนุฏูู:
```
ุฏูุน ูุงุฌุญ ุนุจุฑ Paymob
  โ
ุชูููุฐ ุงูุงุณุชุซูุงุฑ ูุจุงุดุฑุฉ (skipWalletPayment: true)
  โ
โ ูุง ููุฌุฏ ุชุณุฌูู ูู ุนูููุงุช ุงููุญูุธุฉ
โ ูู ุญุงูุฉ ุงููุดูุ ุงููุงู ูุถูุน
```

### ุจุนุฏ ุงูุชุนุฏูู:
```
ุฏูุน ูุงุฌุญ ุนุจุฑ Paymob
  โ
Step 1: ุดุญู ุงูุฑุตูุฏ ูู ุงููุญูุธุฉ โ
  โ
Step 2: ุณุญุจ ุงูุฑุตูุฏ ูู ุงููุญูุธุฉ ูุดุฑุงุก ุงููุฑุตุฉ โ
  โ
โ ุฌููุน ุงูุนูููุงุช ูุณุฌูุฉ ูู ุงููุญูุธุฉ
โ ูู ุญุงูุฉ ุงููุดูุ ุงูุฑุตูุฏ ููุฌูุฏ ูู ุงููุญูุธุฉ
```

---

## ๐ ุงูุชุนุฏููุงุช ูู ุงูููุฏ

### ุงูููู: `app/Services/PaymentWebhookService.php`

#### ุงูุฏุงูุฉ ุงููุนุฏูุฉ: `executeInvestment()`

**ุงูุชุบููุฑุงุช ุงูุฑุฆูุณูุฉ:**

1. **ุฅุถุงูุฉ ุดุญู ุงููุญูุธุฉ ุฃููุงู:**
```php
// Step 1: ุดุญู ุงูุฑุตูุฏ ูู ุงููุญูุธุฉ ุฃููุงู (ููุชุณุฌูู ูู ุนูููุงุช ุงููุญูุธุฉ)
$walletService = app(WalletService::class);
$walletService->depositToWallet($investor, $amountSar, [
    'type' => 'payment_gateway',
    'source' => 'paymob',
    'payment_id' => $intention->id,
    'transaction_id' => $intention->transaction_id,
    'opportunity_id' => $opportunityId,
    'opportunity_name' => $opportunity->name ?? null,
    'description' => "ุดุญู ุฑุตูุฏ ูู ุจูุงุจุฉ ุงูุฏูุน ูุดุฑุงุก ูุฑุตุฉ: {$opportunityName}",
]);
```

2. **ุชุบููุฑ skipWalletPayment ูู true ุฅูู false:**
```php
// Step 2: ุณุญุจ ุงูุฑุตูุฏ ูู ุงููุญูุธุฉ ูุดุฑุงุก ุงููุฑุตุฉ
$investment = $investmentService->invest(
    investor: $investor,
    opportunity: $opportunity,
    shares: $shares,
    investmentType: $extras['investment_type'] ?? 'myself',
    skipWalletPayment: false // โ ุณุญุจ ูู ุงููุญูุธุฉ (ุงูุชู ุชู ุดุญููุง ููุชู)
);
```

3. **ุฅุถุงูุฉ ุชุนูููุงุช ุชูุถูุญูุฉ:**
```php
// ูู ุญุงูุฉ ูุดู ุงูุงุณุชุซูุงุฑุ ุงูุฑุตูุฏ ููุฌูุฏ ูู ุงููุญูุธุฉ ููููู ุงุณุชุฑุฌุงุนู
// ูุง ูุญุชุงุฌ ูุฅุฑุฌุงุน ุงููุงู ูุฃู ุงูุฑุตูุฏ ููุฌูุฏ ูู ุงููุญูุธุฉ ุจุงููุนู
```

---

## ๐ ุณุฌู ุงูุนูููุงุช (Transactions)

### ุนูููุฉ ุดุญู ุงููุญูุธุฉ:
- **ุงูููุน**: `payment_gateway`
- **ุงููุตุฏุฑ**: `paymob`
- **ุงููุตู**: "ุดุญู ุฑุตูุฏ ูู ุจูุงุจุฉ ุงูุฏูุน ูุดุฑุงุก ูุฑุตุฉ: [ุงุณู ุงููุฑุตุฉ]"
- **Metadata**: 
  - `payment_id`: ูุนุฑู ููุฉ ุงูุฏูุน
  - `transaction_id`: ูุนุฑู ุงููุนุงููุฉ ูู Paymob
  - `opportunity_id`: ูุนุฑู ุงููุฑุตุฉ
  - `opportunity_name`: ุงุณู ุงููุฑุตุฉ

### ุนูููุฉ ุณุญุจ ูู ุงููุญูุธุฉ:
- **ุงูููุน**: `investment`
- **ุงููุตู**: "ุงุณุชุซูุงุฑ ูู ูุฑุตุฉ: [ุงุณู ุงููุฑุตุฉ]"
- **Metadata**:
  - `opportunity_id`: ูุนุฑู ุงููุฑุตุฉ
  - `opportunity_name`: ุงุณู ุงููุฑุตุฉ

---

## โ๏ธ ููุงุญุธุงุช ูููุฉ

### 1. ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก

**ูู ุญุงูุฉ ูุดู ุดุญู ุงููุญูุธุฉ:**
- ูุชู ุชุณุฌูู ุงูุฎุทุฃ
- ูุง ูุชู ุฅูุดุงุก ุงูุงุณุชุซูุงุฑ
- ูููู ูููุณุชุฎุฏู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู

**ูู ุญุงูุฉ ูุดู ุดุฑุงุก ุงููุฑุตุฉ ุจุนุฏ ุงูุดุญู:**
- ุงูุฑุตูุฏ ููุฌูุฏ ูู ุงููุญูุธุฉ โ
- ูููู ูููุณุชุฎุฏู:
  - ุฅุนุงุฏุฉ ุงููุญุงููุฉ
  - ุงุณุชุฎุฏุงู ุงูุฑุตูุฏ ูู ูุญูุธุชู
  - ุทูุจ ุงุณุชุฑุฌุงุน ุงูุฑุตูุฏ

### 2. Transaction Safety

ูู ุนูููุฉ (ุดุญู ูุณุญุจ) ููุง transaction ุฎุงุต ุจูุง:
- ุฅุฐุง ูุดูุช ุนูููุฉ ุงูุดุญูุ ูุง ูุชู ุฎุตู ุงููุงู
- ุฅุฐุง ูุฌุญุช ุงูุดุญู ููุดู ุงูุณุญุจุ ุงูุฑุตูุฏ ูุจูู ูู ุงููุญูุธุฉ

### 3. ุงูุชุณุฌูู (Logging)

ุชู ุฅุถุงูุฉ ุชุณุฌูู ุดุงูู:
- ุชุณุฌูู ูุฌุงุญ ุดุญู ุงููุญูุธุฉ
- ุชุณุฌูู ูุฌุงุญ ุชูููุฐ ุงูุงุณุชุซูุงุฑ
- ุชุณุฌูู ุฃู ุฃุฎุทุงุก ุชุญุฏุซ

---

## ๐งช ุณููุงุฑูููุงุช ุงูุงุฎุชุจุงุฑ

### ุงูุณููุงุฑูู 1: ูุฌุงุญ ุงูุนูููุฉ ุงููุงููุฉ
```
1. ุงูุฏูุน ูุฌุญ โ
2. ุดุญู ุงููุญูุธุฉ โ
3. ุดุฑุงุก ุงููุฑุตุฉ โ
4. ุงููุชูุฌุฉ: ุงูุงุณุชุซูุงุฑ ุชู ุจูุฌุงุญ + ุนูููุงุช ุงููุญูุธุฉ ูุณุฌูุฉ
```

### ุงูุณููุงุฑูู 2: ูุดู ุดุฑุงุก ุงููุฑุตุฉ ุจุนุฏ ุงูุดุญู
```
1. ุงูุฏูุน ูุฌุญ โ
2. ุดุญู ุงููุญูุธุฉ โ
3. ุดุฑุงุก ุงููุฑุตุฉ ูุดู โ
4. ุงููุชูุฌุฉ: ุงูุฑุตูุฏ ููุฌูุฏ ูู ุงููุญูุธุฉ + ูููู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู
```

### ุงูุณููุงุฑูู 3: ูุดู ุดุญู ุงููุญูุธุฉ
```
1. ุงูุฏูุน ูุฌุญ โ
2. ุดุญู ุงููุญูุธุฉ ูุดู โ
3. ุดุฑุงุก ุงููุฑุตุฉ ูู ูุชู
4. ุงููุชูุฌุฉ: ูุง ููุฌุฏ ุฎุณุงุฑุฉ ูููุงู + ูููู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู
```

---

## ๐ ููุงุฑูุฉ ูุจู ูุจุนุฏ

| ุงูุฌุงูุจ | ูุจู ุงูุชุนุฏูู | ุจุนุฏ ุงูุชุนุฏูู |
|--------|-------------|-------------|
| ุชุณุฌูู ุนูููุงุช ุงููุญูุธุฉ | โ ูุง | โ ูุนู |
| ุงูุฑุตูุฏ ูู ุญุงูุฉ ุงููุดู | โ ูุถูุน | โ ููุฌูุฏ ูู ุงููุญูุธุฉ |
| ุงูุดูุงููุฉ | โ๏ธ ูุญุฏูุฏุฉ | โ ูุงููุฉ |
| ุฅููุงููุฉ ุงูุงุณุชุฑุฌุงุน | โ ุตุนุจุฉ | โ ุณููุฉ |

---

## โ ุงูุฎูุงุตุฉ

ุชู ุชุทุจูู ุงูุชุนุฏููุงุช ุจูุฌุงุญ:
- โ ุดุญู ุงูุฑุตูุฏ ูู ุงููุญูุธุฉ ุฃููุงู
- โ ุณุญุจ ุงูุฑุตูุฏ ูู ุงููุญูุธุฉ ูุดุฑุงุก ุงููุฑุตุฉ
- โ ุชุณุฌูู ุฌููุน ุงูุนูููุงุช
- โ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุจุดูู ุขูู

**ุงูููู ุงููุนุฏู:**
- `app/Services/PaymentWebhookService.php` - ุฏุงูุฉ `executeInvestment()`

**ุชุงุฑูุฎ ุงูุชุนุฏูู:** $(date)




